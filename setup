#!/bin/sh
# Bootstrap script - run this on a fresh system
# Usage: ./setup

set -e

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"

printf "\033[34mðŸš€ Dotfiles Bootstrap\033[0m\n"

# Check if we have cargo/rust already
if ! command -v cargo >/dev/null 2>&1; then
  printf "\033[33mâ†’ Rust not found, installing rustup...\033[0m\n"
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
  . "$HOME/.cargo/env"
  printf "\033[32mâœ“ Rust installed\033[0m\n"
fi

# Build all binaries
printf "\033[35mâ†’ Building Rust binaries...\033[0m\n"
cd "$DOTFILES_DIR/crates"
cargo install --path . --bins --root "$DOTFILES_DIR" --force

printf "\033[32mâœ“ Binaries built and installed to ~/.dotfiles/bin\033[0m\n"

# Clean up stale binaries from ~/.cargo/bin
printf "\033[35mâ†’ Cleaning up stale cargo binaries...\033[0m\n"
for bin in clean-dls clean-exif echo-to-file embed-art extract-exif-from-flac \
           gen-diff git-squash git-sync git-trigger imp install-font-macos \
           install-terminfo kill-port parallel-dl-extract prune prune-gen \
           regen-zsh-completions to-audio unfuck-xcode upd update-ffmpeg \
           url2base64 vimv; do
  if [ -f "$HOME/.cargo/bin/$bin" ]; then
    rm "$HOME/.cargo/bin/$bin"
    printf "  removed %s\n" "$bin"
  fi
done

# Run upd to complete setup (brew, mise, etc)
printf "\033[36m\nâ†’ Running upd to complete setup...\033[0m\n"
"$DOTFILES_DIR/bin/upd"

printf "\033[32mâœ“ Setup complete!\033[0m\n"
