#!/bin/sh
# Bootstrap script - run this on a fresh system
# Usage: ./setup

set -e

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "ğŸš€ Dotfiles Bootstrap"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Check if we have cargo/rust already
if command -v cargo >/dev/null 2>&1; then
  echo "âœ“ Rust/Cargo found, building and running upd..."
  cd "$DOTFILES_DIR/crates"
  cargo build --release --bin upd
  cp target/release/upd "$DOTFILES_DIR/bin/upd"
  cd "$DOTFILES_DIR"
  exec "$DOTFILES_DIR/bin/upd" "$@"
fi

# Bootstrap mode - install Rust first
echo "â†’ Rust not found, installing rustup..."
echo ""

curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable

# Source cargo env
. "$HOME/.cargo/env"

echo ""
echo "âœ“ Rust installed"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "â†’ Building upd..."
echo ""

cd "$DOTFILES_DIR/crates"
cargo build --release --bin upd
cp target/release/upd "$DOTFILES_DIR/bin/upd"

echo ""
echo "âœ“ upd built"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "â†’ Running bootstrap..."
echo ""

cd "$DOTFILES_DIR"
exec "$DOTFILES_DIR/bin/upd" "$@"
