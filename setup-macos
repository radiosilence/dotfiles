#!/bin/sh
# Bootstrap script - run this on a fresh system
# Usage: git clone https://github.com/radiosilence/dotfiles ~/.dotfiles && ~/.dotfiles/setup

set -e

DOTFILES_DIR="$(cd "$(dirname "$0")" && pwd)"

printf "\033[1m/// .DOTFILES BOOTSTRAP\033[0m\n\n"

# --- Sudo setup (first, so the session carries through the rest) ---
SUDO_LOCAL="/etc/pam.d/sudo_local"
if [ -f "$SUDO_LOCAL" ] && grep -q pam_tid "$SUDO_LOCAL"; then
  printf "\033[32m  ok touchid sudo\033[0m\n"
else
  printf "\033[33m  -> enabling touchid for sudo...\033[0m\n"
  sudo sh -c 'echo "auth       sufficient     pam_tid.so" > /etc/pam.d/sudo_local'
  printf "\033[32m  ok touchid sudo\033[0m\n"
fi

SUDO_TIMEOUT="/etc/sudoers.d/timeout"
if [ -f "$SUDO_TIMEOUT" ]; then
  printf "\033[32m  ok sudo timeout\033[0m\n"
else
  printf "\033[33m  -> setting sudo timeout to 30 min...\033[0m\n"
  sudo sh -c 'echo "Defaults timestamp_timeout=30" > /etc/sudoers.d/timeout && chmod 0440 /etc/sudoers.d/timeout'
  printf "\033[32m  ok sudo timeout\033[0m\n"
fi

# --- Xcode Command Line Tools ---
if xcode-select -p >/dev/null 2>&1; then
  printf "\033[32m  ok xcode CLT\033[0m\n"
else
  printf "\033[33m  -> installing xcode command line tools...\033[0m\n"
  # Sentinel file makes CLT appear in softwareupdate list
  touch /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
  CLT_LABEL=$(/usr/sbin/softwareupdate -l 2>&1 |
    grep -B 1 -E 'Command Line Tools' |
    awk -F'*' '/^ *\*/ {print $2}' |
    sed -e 's/^ *Label: //' -e 's/^ *//' |
    sort -V |
    tail -n1)
  if [ -n "$CLT_LABEL" ]; then
    /usr/sbin/softwareupdate -i "$CLT_LABEL" --verbose
    /usr/bin/xcode-select --switch /Library/Developer/CommandLineTools
  else
    rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
    printf "\033[31m  !! could not find CLT in softwareupdate\033[0m\n"
    printf "     download manually: https://developer.apple.com/download/all/\n"
    exit 1
  fi
  rm -f /tmp/.com.apple.dt.CommandLineTools.installondemand.in-progress
  printf "\033[32m  ok xcode CLT installed\033[0m\n"
fi

# --- Rosetta 2 (Apple Silicon only) ---
if [ "$(uname -m)" = "arm64" ]; then
  if /usr/bin/pgrep -q oahd 2>/dev/null; then
    printf "\033[32m  ok rosetta 2\033[0m\n"
  else
    printf "\033[33m  -> installing rosetta 2...\033[0m\n"
    /usr/sbin/softwareupdate --install-rosetta --agree-to-license
    printf "\033[32m  ok rosetta 2 installed\033[0m\n"
  fi
fi

# --- Homebrew ---
if command -v brew >/dev/null 2>&1; then
  printf "\033[32m  ok homebrew\033[0m\n"
else
  printf "\033[33m  -> installing homebrew...\033[0m\n"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  # Get brew into PATH for rest of script
  if [ -d /opt/homebrew ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  else
    eval "$(/usr/local/bin/brew shellenv)"
  fi
  printf "\033[32m  ok homebrew installed\033[0m\n"
fi

# --- Brewfile symlink ---
BREWFILE_TARGET="$HOME/Brewfile"
if [ -L "$BREWFILE_TARGET" ] && [ "$(readlink "$BREWFILE_TARGET")" = "$DOTFILES_DIR/Brewfile" ]; then
  printf "\033[32m  ok brewfile linked\033[0m\n"
else
  ln -sf "$DOTFILES_DIR/Brewfile" "$BREWFILE_TARGET"
  printf "\033[32m  ok brewfile linked\033[0m\n"
fi

# --- brew bundle ---
printf "\n\033[1m/// .BREW BUNDLE\033[0m\n\n"
brew bundle --file="$DOTFILES_DIR/Brewfile" --quiet || true

# --- mise tools ---
if command -v mise >/dev/null 2>&1; then
  printf "\n\033[1m/// .MISE TOOLS\033[0m\n\n"
  export PATH="$HOME/.local/share/mise/shims:$PATH"
  printf "\033[33m  -> mise install...\033[0m\n"
  mise install
  printf "\033[32m  ok mise tools\033[0m\n"
else
  printf "\033[31m  !! mise not found after brew bundle - check Brewfile\033[0m\n"
  exit 1
fi

printf "\n\033[1m/// .BUILD\033[0m\n\n"
mise run reinstall-bins

# --- Run upd ---
printf "\n"
"$DOTFILES_DIR/bin/upd"
