#!/usr/bin/env fish

set min_size 3096
set target_dir .
set script (basename (status -f))
argparse --name=$script m/min-size= -- $argv

if set -q _flag_min_size
    set min_size $_flag_min_size
end

set candidates (find $target_dir -type d -exec du -sk {} + | awk -v min=$min_size '$1 < min { $1=""; sub(/^ /, ""); print }')

set -l to_delete

for candidate in $candidates
    if test $candidate = "."; or string match -rq "\.*.(stfolder|git).*" $candidate
        continue
    end
    set to_delete $to_delete $candidate
end

if test -z to_delete
    echo "No directories below $min_size kB in $target_dir."
    exit 0
end

echo "The following directories are below $min_size kB and would be deleted:"

for dir in $to_delete
    echo (du -h $dir | tail -n 1)
end

read -P "Are you sure you want to delete these directories? [y/N] " confirm

if string match -i y $confirm
    for dir in $to_delete
        if test $dir = "."
            continue
        end
        if test -d $dir
            echo "Deleting $dir"
            rm -rf $dir
        end
    end
    echo "Directories deleted."
else
    echo "Operation canceled."
end
