#!/usr/bin/env fish
# Default bitrate
set bitrate 160
set -l dirs .
set -l options \
    b/bitrate= \
    h/help
# Function to display usage
function show_help
    echo "Usage: $0 <directory> [-b <bitrate>]"
    echo "  directory: Path to audio files (required)"
    echo "  -b: Bitrate for OPUS conversion (optional, default: 160)"
    echo "  Example: $0 /path/to/audio -b 320"
    exit 1
end

# Parse command line arguments
argparse --name=myscript $options -- $argv
or exit

# Update values based on provided flags
if set -q _flag_bitrate
    set bitrate $_flag_bitrate
end

if test (count $argv) -gt 0
    set -l dirs $argv
end

echo "Directories: $dirs"
echo "Bitrate: $bitrate kbps"

for dir in $dirs
    echo "Converting files in $dir to OPUS format at $bitrate kbps..."
    for file in $dir/*.{flac,alac,mp3,aiff,wav}
        ffmpeg -i "$file" -c:a libopus -b:a "$bitrate"k $(path basename -E $file).$bitrate.opus
    end
end
