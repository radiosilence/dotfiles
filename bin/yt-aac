#!/usr/bin/env zsh

# Check if a YouTube URL is provided
if [[ -z "$1" ]]; then
  echo "Usage: $0 <YouTube URL>"
  exit 1
fi

# Set variables
URL="$1"
TEMP_DIR=$(mktemp -d)
OUTPUT_FILE="${TEMP_DIR}/%(title)s.%(ext)s"

# Download video and extract audio
echo "Downloading and extracting audio..."
yt-dlp \
  --format bestaudio/best \
  --extract-audio \
  --audio-format aac \
  --output "$OUTPUT_FILE" \
  "$URL"

# Get metadata
VIDEO_INFO=$(yt-dlp --print-json "$URL")
VIDEO_TITLE=$(echo "$VIDEO_INFO" | jq -r '.title')
CHANNEL_NAME=$(echo "$VIDEO_INFO" | jq -r '.uploader')

# Process downloaded file
DOWNLOADED_FILE=$(find "$TEMP_DIR" -type f -name "*.m4a")
if [[ -f "$DOWNLOADED_FILE" ]]; then
  echo "Tagging the file with metadata..."
  ffmpeg -i "$DOWNLOADED_FILE" \
    -metadata albumartist="YouTube" \
    -metadata title="$VIDEO_TITLE" \
    -metadata artist="$CHANNEL_NAME" \
    -metadata album="$CHANNEL_NAME" \
    -codec copy "${DOWNLOADED_FILE%.m4a}.tagged.m4a"

  # Rename tagged file and clean up
  mv "${DOWNLOADED_FILE%.m4a}.tagged.m4a" "$DOWNLOADED_FILE"
else
  echo "Error: Failed to find the downloaded M4A file."
  exit 1
fi

# Open Finder in the temporary directory
echo "Opening Finder in temporary directory: $TEMP_DIR"
open "$TEMP_DIR"
