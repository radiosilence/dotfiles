#!/bin/sh
cd "$(dirname "$0")" || exit
DOTFILES=~/.dotfiles
BACKUP_DIR="$HOME/.dotfiles-backup-$(date +%Y%m%d-%H%M%S)"

# Only pull if we're in a git repo and have network access
if [ -d "$DOTFILES/.git" ]; then
  printf "\033[36mðŸ”„ Updating dotfiles...\033[0m\n"
  (cd "$DOTFILES" && git pull 2> /dev/null) || printf "\033[33mâš ï¸  Warning: Could not update dotfiles repository\033[0m\n"
fi

backup_if_exists() {
  target="$1"
  if [ -e "$target" ] || [ -h "$target" ]; then
    if [ ! -d "$BACKUP_DIR" ]; then
      mkdir -p "$BACKUP_DIR"
      printf "\033[33mðŸ’¾ Creating backup directory: $BACKUP_DIR\033[0m\n"
    fi
    backup_path="$BACKUP_DIR/$(basename "$target")"
    printf "\033[33mðŸ’¾ Backing up $target -> $backup_path\033[0m\n"
    mv "$target" "$backup_path"
  fi
}

link_dotfile() {
  if [ "$1" = "." ] || [ "$1" = ".." ]; then
    return
  fi
  if [ -h "$HOME/$1" ]; then
    printf "\033[90mâœ“ skipping $1 (link)\033[0m\n"
    return
  fi
  if [ -f "$HOME/$1" ]; then
    printf "\033[90mâœ“ skipping $1 (file)\033[0m\n"
    return
  fi
  if [ -d "$HOME/$1" ]; then
    printf "\033[90mâœ“ skipping $1 (dir)\033[0m\n"
    return
  fi
  if [ ".config" = "$1" ]; then
    printf "\033[90mâœ“ skipping $1 (.config)\033[0m\n"
    return
  fi

  case "$1" in
    *.git | .gitignore | ".|.." | .vscode | .sonarlint) return ;;
  esac

  echo "$PWD/$1"

  printf "\033[32mðŸ”— linking $PWD/$1 -> $HOME/$1\033[0m\n"
  ln -s "$PWD/$1" "$HOME/$1"
}

link_confdir() {
  if [ ! -e "$HOME/.config" ]; then
    printf "\033[34mðŸ“ creating ~/.config\033[0m\n"
    mkdir "$HOME/.config"
  fi

  # Check if it's already the correct symlink
  if [ -h "$HOME/.config/$1" ] && [ "$(readlink "$HOME/.config/$1")" = "$PWD/$1" ]; then
    printf "\033[90mâœ“ skipping ~/.config/$1 (correct link)\033[0m\n"
    return
  fi

  # Backup and remove existing file/directory/wrong symlink
  if [ -e "$HOME/.config/$1" ] || [ -h "$HOME/.config/$1" ]; then
    backup_if_exists "$HOME/.config/$1"
  fi

  printf "\033[32mðŸ”— linking $PWD/$1 --> ~/.config/$1\033[0m\n"
  ln -s "$PWD/$1" "$HOME/.config/$1"
}

install_dotfiles() {
  [ ! -e "$DOTFILES" ] && return
  printf "\n\033[1;36mðŸ  Installing dotfiles from $DOTFILES...\033[0m\n"
  (
    cd "$DOTFILES" || exit
    for file in .*; do
      link_dotfile "$file"
    done
  )
}

install_confdirs() {
  (
    cd config || exit
    for confdir in *; do
      link_confdir "$confdir"
    done
  )
}

install_brewfile() {
  if [ -e /Library ] && [ ! -e "$HOME/Brewfile" ]; then
    printf "\033[32mðŸ”— linking Brewfile $DOTFILES/Brewfile -> ~/Brewfile\033[0m\n"
    ln -s "$DOTFILES/Brewfile" "$HOME/Brewfile"
  fi
}

install_gitconfig() {
  # Create ~/.gitconfig if it doesn't exist
  if [ ! -f ~/.gitconfig ]; then
    touch ~/.gitconfig
  fi

  if ! grep '.dotfiles' ~/.gitconfig > /dev/null 2>&1; then
    printf "\033[35mâš™ï¸  Adding ~/.dotfiles/git.d/core.conf to ~/.gitconfig\033[0m\n"
    printf "\n[include]\npath = ~/.dotfiles/git.d/core.conf\n" >> ~/.gitconfig
  fi
}

install_sshconfig() {
  # Create ~/.ssh/config if it doesn't exist
  if [ ! -f ~/.ssh/config ]; then
    mkdir -p ~/.ssh
    touch ~/.ssh/config
    chmod 600 ~/.ssh/config
  fi

  if ! grep '.dotfiles' ~/.ssh/config > /dev/null 2>&1; then
    printf "\033[35mðŸ” Adding ~/.dotfiles/ssh.d/*.conf to ~/.ssh/config\033[0m\n"
    printf "\nInclude ~/.dotfiles/ssh.d/*.conf\n" >> ~/.ssh/config
  fi
}

install_sheldon_plugins() {
  if command -v sheldon > /dev/null 2>&1; then
    printf "\033[36mðŸ”Œ Installing Sheldon plugins...\033[0m\n"
    if sheldon source > /dev/null 2>&1; then
      printf "\033[32mâœ… Sheldon plugins installed successfully\033[0m\n"
    else
      printf "\033[33mâš ï¸  Warning: Sheldon plugin installation failed\033[0m\n"
    fi
  else
    printf "\033[90mâœ“ Sheldon not found, skipping plugin installation\033[0m\n"
  fi
}

install_dotfiles
install_confdirs
install_brewfile
install_sshconfig
install_gitconfig
install_sheldon_plugins

cd - > /dev/null || exit
